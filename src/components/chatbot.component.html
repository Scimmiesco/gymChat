<div class="flex flex-col h-full w-full max-w-4xl mx-auto bg-gray-800/50 shadow-2xl">
  
  <!-- Header -->
  <header (click)="showProfile.set(true)" class="flex items-center p-3 bg-[#202c33] cursor-pointer shrink-0">
    <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-xl mr-4">
      <span>ðŸ‘¤</span>
    </div>
    <div>
      <h3 class="font-semibold">Meu DiÃ¡rio de Treino</h3>
      <p class="text-xs text-gray-400">online</p>
    </div>
  </header>

  <!-- Messages -->
  <div #chatContainer class="flex-1 p-4 sm:p-6 space-y-4 overflow-y-auto min-w-1/2 chat-container">
    @for (message of messages(); track message.id) {
      <div class="flex animate-fade-in" [class.justify-end]="message.role === 'user'">
        <div 
          class="max-w-sm md:max-w-xl rounded-lg px-3 py-2 shadow-md relative" 
          [class.chat-bubble-user]="message.role === 'user'" 
          [class.chat-bubble-model]="message.role === 'model'">

          @switch(message.type) {
            @case('loading') {
              <div class="flex items-center space-x-2 py-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:0.2s]"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:0.4s]"></div>
              </div>
            }
            @case('error') {
              <p class="whitespace-pre-wrap text-red-400">{{ message.text }}</p>
            }
            @case('text') {
              <p class="whitespace-pre-wrap">{{ message.text }}</p>
            }
             @case('quick_actions') {
              <p class="whitespace-pre-wrap">{{ message.text }}</p>
              <div class="mt-2 flex flex-wrap gap-2">
                @for(action of message.payload; track action) {
                  <button (click)="sendQuickAction(action)" class="bg-emerald-800/70 text-emerald-300 text-sm font-semibold py-1.5 px-3 rounded-full hover:bg-emerald-700/70 transition-colors">
                    {{ action }}
                  </button>
                }
              </div>
            }
            @case('workout_log') {
              <div>
                <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
                <app-workout-card [workout]="message.payload" (deleteRequest)="deleteWorkout($event, message.id)"></app-workout-card>
              </div>
            }
            @case('stats_summary') {
              <div>
                <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div class="bg-black/20 p-3 rounded-lg text-center">
                    <h4 class="text-xs text-gray-400">Total de Treinos</h4>
                    <p class="text-2xl font-bold">{{ message.payload.totalWorkouts }}</p>
                  </div>
                  <div class="bg-black/20 p-3 rounded-lg text-center">
                    <h4 class="text-xs text-gray-400">Calorias (Est.)</h4>
                    <p class="text-2xl font-bold">{{ message.payload.totalCalories | number:'1.0-0' }}</p>
                  </div>
                </div>
              </div>
            }
             @case('history_summary') {
              <div>
                <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
                @if(workouts().length > 0) {
                  <div class="space-y-4 mt-2 max-h-80 overflow-y-auto pr-2 chat-container">
                    @for(group of groupedWorkouts(); track group[0]) {
                      <div>
                        <h5 class="font-bold text-base text-gray-300 mb-2 sticky top-0 bg-gray-800/80 backdrop-blur-sm py-1 z-10">{{ getFriendlyDateHeader(group[0]) }}</h5>
                        <div class="space-y-2">
                           @for(workout of group[1]; track workout.id) {
                            <app-workout-card 
                              [workout]="workout"
                              (deleteRequest)="deleteWorkout($event)">
                            </app-workout-card>
                          }
                        </div>
                      </div>
                    }
                  </div>
                } @else {
                  <p class="text-sm text-gray-400 italic mt-2">Nenhum treino no histÃ³rico.</p>
                }
              </div>
            }
             @case('user_profile') {
                <div>
                    <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
                    <div class="bg-black/20 p-3 rounded-lg space-y-1 text-sm">
                        <p><strong>FÃ­sico:</strong> {{ message.payload.physique }}</p>
                        <p><strong>Idade:</strong> {{ message.payload.age }} anos</p>
                        <p><strong>Altura:</strong> {{ message.payload.height }} cm</p>
                        <p><strong>Peso:</strong> {{ message.payload.weight }} kg</p>
                        <p><strong>TMB (Est.):</strong> {{ message.payload.bmr | number:'1.0-0' }} kcal/dia</p>
                    </div>
                </div>
            }
          }
          <div class="text-xs text-gray-400 text-right mt-1">{{ message.timestamp | date:'HH:mm' }}</div>
        </div>
      </div>
    }
  </div>

  <!-- Input Form -->
  <footer class="p-3 bg-[#202c33] shrink-0">
    <form (submit)="sendMessage()" class="flex items-center space-x-3">
      <input 
        type="text"
        [(ngModel)]="userInput"
        name="userInput"
        placeholder="Digite seu treino..."
        class="flex-1 bg-[#2a3942] rounded-full py-2 px-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500"
        [disabled]="isLoading()"
        autocomplete="off">
      <button type="submit" [disabled]="!userInput() || isLoading()" class="bg-emerald-600 text-white rounded-full w-11 h-11 flex items-center justify-center shrink-0 disabled:bg-gray-600 disabled:cursor-not-allowed hover:bg-emerald-700 transition-colors">
        <span class="text-xl -mr-1">âž¤</span>
      </button>
    </form>
  </footer>
</div>

<!-- Profile Modal -->
@if (showProfile()) {
  <div (click)="showProfile.set(false)" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 animate-fade-in">
    <div (click)="$event.stopPropagation()" class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-gray-700">
      <div class="flex flex-col items-center text-center">
        <div class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center text-5xl mb-4">
          <span>ðŸ‘¤</span>
        </div>
        <h2 class="text-2xl font-bold">Perfil do UsuÃ¡rio</h2>
        <p class="text-gray-400">Estes dados sÃ£o usados para calcular as estimativas.</p>
        <div class="text-left space-y-2 mt-6 w-full bg-gray-900/50 p-4 rounded-lg">
          <p><strong>FÃ­sico:</strong> <span class="text-emerald-400 font-medium">{{ userProfile.physique }}</span></p>
          <p><strong>Idade:</strong> <span class="text-emerald-400 font-medium">{{ userProfile.age }} anos</span></p>
          <p><strong>Altura:</strong> <span class="text-emerald-400 font-medium">{{ userProfile.height }} cm</span></p>
          <p><strong>Peso:</strong> <span class="text-emerald-400 font-medium">{{ userProfile.weight }} kg</span></p>
          <p><strong>Sexo:</strong> <span class="text-emerald-400 font-medium">{{ userProfile.gender }}</span></p>
          <p class="border-t border-gray-700 pt-2 mt-2"><strong>TMB (Est.):</strong> <span class="text-emerald-400 font-medium">{{ userProfile.bmr | number:'1.0-0' }} kcal/dia</span></p>
        </div>
        <button (click)="showProfile.set(false)" class="mt-6 bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg w-full hover:bg-emerald-700 transition-colors">
          Fechar
        </button>
      </div>
    </div>
  </div>
}

<input type="file" #importFileInput class="hidden" (change)="importData($event)" accept=".json">