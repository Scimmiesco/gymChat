<div
  class="relative flex flex-col h-full w-full max-w-4xl mx-auto bg-slate-800/50 shadow-2xl"
>
  <!-- Header -->
  <header class="flex items-center justify-between p-3 bg-slate-900 shrink-0">
    <div
      (click)="showProfile.set(true)"
      class="flex items-center cursor-pointer"
    >
      <div
        class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center text-xl mr-4"
      >
        <span>üë§</span>
      </div>
      <div>
        <h3 class="font-semibold">Gymini</h3>
      </div>
    </div>

    <div class="flex items-center space-x-1 sm:space-x-2">
      <button
        (click)="sendQuickAction('Ver meu hist√≥rico')"
        class="text-2xl transition-colors p-2 rounded-full"
        title="Ver Hist√≥rico"
      >
        <span>üìú</span>
      </button>
      <button
        (click)="sendQuickAction('Mostrar resumo')"
        class="text-2xl transition-colors p-2 rounded-full"
        title="Mostrar Resumo"
      >
        <span>üìä</span>
      </button>
      <button
        (click)="showSettings.set(true)"
        class="text-2xl transition-colors p-2 rounded-full"
        title="Configura√ß√µes"
      >
        <span>‚öôÔ∏è</span>
      </button>
    </div>
  </header>

  <!-- Messages -->
  <div
    #chatContainer
    (scroll)="onChatScroll($event)"
    class="flex-1 p-4 space-y-4 overflow-y-auto min-w-1/2 chat-container relative pb-20"
  >
    @for (message of messages(); track message.id) {
    <div
      class="flex animate-fade-in"
      [class.justify-end]="message.role === 'user'"
    >
      <div
        class="w-11/12 md:w-3/4 rounded-md p-2 relative backdrop-blur-sm border-2 border-slate-900"
        [class.chat-bubble-user]="message.role === 'user'"
        [class.chat-bubble-model]="message.role === 'model'"
      >
        @switch (message.type) { @case ('loading') {
        <div class="flex items-center space-x-2 py-1">
          <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
          <div
            class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:0.2s]"
          ></div>
          <div
            class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:0.4s]"
          ></div>
        </div>
        } @case ('error') {
        <p class="whitespace-pre-wrap text-red-400">{{ message.text }}</p>
        } @case ('text') {
        <p class="whitespace-pre-wrap">{{ message.text }}</p>
        } @case ('quick_actions') {
        <p class="whitespace-pre-wrap">{{ message.text }}</p>
        <div class="mt-2 flex flex-wrap gap-2">
          @for (action of message.payload; track action) {
          <button
            (click)="sendQuickAction(action)"
            class="bg-emerald-800/70 text-emerald-300 text-sm font-semibold py-1.5 px-3 rounded-full hover:bg-emerald-700/70 transition-colors"
          >
            {{ action }}
          </button>
          }
        </div>
        } @case ('workout_log') {
        <div>
          <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
          <app-workout-card
            [workout]="message.payload"
            (deleteRequest)="deleteWorkout($event, message.id)"
          ></app-workout-card>
        </div>
        } @case ('stats_summary') {
        <app-stats-summary-card
          [title]="message.text!"
          [stats]="message.payload"
        >
        </app-stats-summary-card>
        } @case ('history_summary') {
        <div>
          <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
          @if (workouts().length > 0) {
          <div
            class="space-y-4 mt-2 max-h-80 overflow-y-auto pr-2 chat-container"
          >
            @for (group of groupedWorkouts(); track group.date) {
            <div>
              <div
                class="mb-2 flex justify-between sticky py-1 px-3 rounded-md border-2 border-emerald-600 text-center top-0 backdrop-blur-sm z-10 bg-emerald-600/75"
              >
                <h5 class="font-bold text-xl">
                  {{ getFriendlyDateHeader(group.date) }}
                </h5>
                <span
                  >@if (group.totalCalories > 0) {
                  <span class="text-md font-bold text-emerald-200"
                    >~{{ group.totalCalories | number : "1.0-0" }} cals</span
                  >
                  }üî•
                </span>
              </div>

              <div class="flex flex-col gap-2">
                @for (workout of group.workouts; track workout.id) {
                <app-workout-card
                  [workout]="workout"
                  (deleteRequest)="deleteWorkout($event)"
                >
                </app-workout-card>
                }
              </div>
            </div>
            }
          </div>
          } @else {
          <p class="text-sm italic mt-2">Nenhum treino no hist√≥rico.</p>
          }
        </div>
        } @case ('user_profile') {
        <div>
          <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
          <div class="bg-slate-900/20 p-3 rounded-md space-y-1 text-sm">
            <p><strong>F√≠sico:</strong> {{ message.payload.physique }}</p>
            <p><strong>Idade:</strong> {{ message.payload.age }} anos</p>
            <p><strong>Altura:</strong> {{ message.payload.height }} cm</p>
            <p><strong>Peso:</strong> {{ message.payload.weight }} kg</p>
            <p>
              <strong>TMB (Est.):</strong>
              {{ message.payload.bmr | number : "1.0-0" }} cal/dia
            </p>
          </div>
        </div>
        } }
        <div class="text-xs text-right mt-1">
          {{ message.timestamp | date : "HH:mm" }}
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Input Form -->
  <footer class="absolute bottom-0 left-0 right-0 p-2">
    <form (submit)="sendMessage()" class="flex items-end space-x-3">
      <textarea
        rows="1"
        [(ngModel)]="userInput"
        name="userInput"
        placeholder="Digite seu treino..."
        (keydown)="onKeydown($event)"
        (input)="autoResize($event.target)"
        class="flex-1 w-full bg-[#2a394275] backdrop-blur-sm rounded-md py-2 px-4 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none max-h-32"
        [disabled]="isLoading()"
        autocomplete="off"
      ></textarea>
      <button
        type="submit"
        [disabled]="!userInput() || isLoading()"
        class="bg-emerald-600/50 backdrop-blur-sm rounded-full w-11 h-11 flex items-center justify-center shrink-0 disabled:bg-slate-600 disabled:cursor-not-allowed hover:bg-emerald-700 transition-colors"
      >
        <span class="text-xl -mr-1">‚û§</span>
      </button>
    </form>

    <!-- Scroll to bottom button -->
    @if (showScrollButton()) {
    <button
      (click)="smoothScrollToBottom()"
      class="absolute bottom-20 right-4 z-50 bg-emerald-600/50 backdrop-blur-sm rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:bg-emerald-700 transition-all animate-fade-in"
      title="Ir para mensagens recentes"
    >
      <span class="text-2xl">‚¨áÔ∏è</span>
    </button>
    }
  </footer>

  <!-- Profile Modal -->
  @if (showProfile()) {
  <div
    (click)="showProfile.set(false)"
    class="fixed inset-0 bg-slate-900/70 z-50 flex items-center justify-center p-4 animate-fade-in"
  >
    <div
      (click)="$event.stopPropagation()"
      class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700"
    >
      <div class="flex flex-col items-center text-center">
        <div
          class="w-20 h-20 rounded-full bg-slate-600 flex items-center justify-center text-5xl mb-4"
        >
          <span>üë§</span>
        </div>
        <h2 class="text-2xl font-bold">Perfil do Usu√°rio</h2>
        <p class="">Estes dados s√£o usados para calcular as estimativas.</p>
        <div
          class="text-left space-y-2 mt-6 w-full bg-slate-900/50 p-4 rounded-md"
        >
          <p>
            <strong>F√≠sico:</strong>
            <span class="text-emerald-400 font-medium">{{
              userProfile.physique
            }}</span>
          </p>
          <p>
            <strong>Idade:</strong>
            <span class="text-emerald-400 font-medium"
              >{{ userProfile.age }} anos</span
            >
          </p>
          <p>
            <strong>Altura:</strong>
            <span class="text-emerald-400 font-medium"
              >{{ userProfile.height }} cm</span
            >
          </p>
          <p>
            <strong>Peso:</strong>
            <span class="text-emerald-400 font-medium"
              >{{ userProfile.weight }} kg</span
            >
          </p>
          <p>
            <strong>Sexo:</strong>
            <span class="text-emerald-400 font-medium">{{
              userProfile.gender
            }}</span>
          </p>
          <p class="border-t border-slate-700 pt-2 mt-2">
            <strong>TMB (Est.):</strong>
            <span class="text-emerald-400 font-medium"
              >{{ userProfile.bmr | number : "1.0-0" }} cal/dia</span
            >
          </p>
        </div>
        <button
          (click)="showProfile.set(false)"
          class="mt-6 bg-emerald-600 font-bold py-2 px-6 rounded-md w-full hover:bg-emerald-700 transition-colors"
        >
          Fechar
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Settings Modal -->
  @if (showSettings()) {
  <div
    (click)="showSettings.set(false)"
    class="fixed inset-0 bg-slate-900/70 z-50 flex items-center justify-center p-4 animate-fade-in"
  >
    <div
      (click)="$event.stopPropagation()"
      class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700"
    >
      <h2 class="text-2xl font-bold text-center">Configura√ß√µes</h2>
      <p class="text-center mt-1 mb-6">Gerencie suas chaves de API.</p>

      <div class="space-y-2">
        <label for="apiKey" class="text-sm font-medium text-slate-300"
          >Chave de API DeepSeek</label
        >
        <input
          id="apiKey"
          type="password"
          [(ngModel)]="apiKeyInput"
          name="apiKeyInput"
          placeholder="Insira sua chave de API aqui"
          class="w-full bg-[#2a3942] rounded-md py-2 px-4 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500"
        />
        <p class="text-xs ">
          Sua chave √© salva localmente e nunca sai do seu navegador.
        </p>
      </div>

      <div class="flex items-center gap-4 mt-6">
        <button
          (click)="showSettings.set(false)"
          class="bg-slate-600 font-bold py-2 px-6 rounded-md w-full hover:bg-slate-700 transition-colors"
        >
          Cancelar
        </button>
        <button
          (click)="saveSettings()"
          [disabled]="!apiKeyInput()"
          class="bg-emerald-600 font-bold py-2 px-6 rounded-md w-full hover:bg-emerald-700 transition-colors disabled:bg-slate-500 disabled:cursor-not-allowed"
        >
          Salvar
        </button>
      </div>
    </div>
  </div>
  }

  <input
    type="file"
    #importFileInput
    class="hidden"
    (change)="importData($event)"
    accept=".json"
  />
</div>

