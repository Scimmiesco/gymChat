<div
  class="relative flex flex-col h-full w-full max-w-4xl mx-auto bg-slate-800/25"
>
  <!-- Header -->
  <app-header
    [(showProfile)]="showProfile"
    [(showSettings)]="showSettings"
    (quickAction)="sendQuickAction($event)"
  ></app-header>

  <!-- Messages -->
  <div
    #chatContainer
    (scroll)="onChatScroll($event)"
    class="flex-1 space-y-4 overflow-y-auto min-w-1/2 chat-container relative pb-20 bg-slate-900/50 overflow-x-hidden"
  >
    @for (message of messages(); track message.id) {
    <div
      class="flex animate-fade-in"
      [class.justify-end]="message.role === 'user'"
    >
      <div
        class="md:w-3/4 rounded-md p-2 relative backdrop-blur-sm"
        [class.chat-bubble-user]="message.role === 'user'"
        [class.chat-bubble-model]="message.role === 'model'"
      >
        @switch (message.type) { @case ('loading') {
        <div class="flex items-center space-x-2 py-1">
          <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
          <div
            class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:0.2s]"
          ></div>
          <div
            class="w-2 h-2 bg-slate-400 rounded-full animate-pulse [animation-delay:0.4s]"
          ></div>
        </div>
        } @case ('error') {
        <p class="whitespace-pre-wrap text-red-400">{{ message.text }}</p>
        } @case ('text') {
        <p class="whitespace-pre-wrap">{{ message.text }}</p>
        } @case ('quick_actions') {
        <p class="whitespace-pre-wrap">{{ message.text }}</p>
        <div class="mt-2 flex flex-wrap gap-2">
          @for (action of message.payload; track action) {
          <button
            (click)="sendQuickAction(action)"
            class="bg-emerald-600/70 text-emerald-300 text-sm font-semibold py-1.5 px-3 rounded-full hover:bg-emerald-600/70 transition-colors"
          >
            {{ action }}
          </button>
          }
        </div>
        } @case ('workout_log') {
        <div>
          <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
          <app-workout-card
            [workout]="message.payload"
            (deleteRequest)="deleteWorkout($event, message.id)"
          ></app-workout-card>
        </div>
        } @case ('stats_summary') {
        <app-stats-summary-card
          [title]="message.text!"
          [stats]="message.payload"
        >
        </app-stats-summary-card>
        } @case ('history_summary') {
        <div>
          <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
          @if (workouts().length > 0) {
          <div
            class="space-y-2 mt-2 max-h-[400px] overflow-y-auto pr-2 chat-container"
          >
            @for (weekGroup of groupedWorkoutsByWeek(); track
            weekGroup.weekIdentifier) {
            <div class="bg-slate-900/40 rounded-lg overflow-hidden">
              <button
                (click)="toggleWeek(weekGroup.weekIdentifier)"
                class="w-full p-3 text-left bg-slate-800/50 hover:bg-slate-800/80 transition-colors focus:outline-none flex justify-between items-center"
              >
                <div>
                  <h4 class="font-bold text-white">
                    {{ weekGroup.weekLabel }}
                  </h4>
                  <p class="text-xs text-slate-400">
                    {{ weekGroup.totalWorkouts }} treinos ‚Ä¢
                    {{ weekGroup.totalDuration }} min ‚Ä¢ ~{{
                      weekGroup.totalCalories | number : "1.0-0"
                    }}
                    cals
                  </p>
                </div>
                <span
                  class="text-xl transition-transform duration-200"
                  [class.rotate-180]="!isWeekOpen(weekGroup.weekIdentifier)"
                  >‚ñº</span
                >
              </button>

              @if (isWeekOpen(weekGroup.weekIdentifier)) {
              <div class="p-3 space-y-4 animate-fade-in">
                @for (dayGroup of weekGroup.dayGroups; track dayGroup.date) {
                <div>
                  <div
                    class="mb-2 flex justify-between items-center sticky py-1 px-2 rounded-md top-0 backdrop-blur-sm z-10 bg-emerald-800/60"
                  >
                    <h5 class="font-bold text-md text-emerald-200">
                      {{ getFriendlyDateHeader(dayGroup.date) }}
                    </h5>
                    @if (dayGroup.totalCalories > 0) {
                    <span class="text-xs font-bold text-emerald-300"
                      >~{{ dayGroup.totalCalories | number : "1.0-0" }} cals
                      üî•</span
                    >
                    }
                  </div>
                  <div class="flex flex-col gap-2">
                    @for (workout of dayGroup.workouts; track workout.id) {
                    <app-workout-card
                      [workout]="workout"
                      (deleteRequest)="deleteWorkout($event)"
                    >
                    </app-workout-card>
                    }
                  </div>
                </div>
                }
              </div>
              }
            </div>
            }
          </div>
          } @else {
          <p class="text-sm italic mt-2">Nenhum treino no hist√≥rico.</p>
          }
        </div>
        } @case ('user_profile') {
        <div>
          <p class="text-sm font-semibold mb-2">{{ message.text }}</p>
          <div class="p-1 space-y-1 text-sm">
            <p><strong>F√≠sico:</strong> {{ message.payload.physique }}</p>
            <p><strong>Idade:</strong> {{ message.payload.age }} anos</p>
            <p><strong>Altura:</strong> {{ message.payload.height }} cm</p>
            <p><strong>Peso:</strong> {{ message.payload.weight }} kg</p>
            <p>
              <strong>TMB (Est.):</strong>
              {{ message.payload.bmr | number : "1.0-0" }} cal/dia
            </p>
          </div>
        </div>
        } }
        <div
          [class.hora-container-model]="message.role === 'model'"
          class="text-xs text-right mt-1"
        >
          {{ message.timestamp | date : "HH:mm" }}
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Input Form -->
  <footer class="absolute bottom-0 left-0 right-0 p-2">
    <app-chat-input
      [(userInput)]="userInput"
      (sendMessage)="sendMessage()"
      [isLoading]="isLoading()"
    ></app-chat-input>

    <!-- Scroll to bottom button -->
    @if (showScrollButton()) {
    <button
      (click)="smoothScrollToBottom()"
      class="absolute bottom-20 right-4 z-50 bg-emerald-600/50 backdrop-blur-sm rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:bg-emerald-600 transition-all animate-fade-in"
      title="Ir para mensagens recentes"
    >
      <span class="text-2xl">‚¨áÔ∏è</span>
    </button>
    }
  </footer>

  <!-- Profile Modal -->
  @if (showProfile()) {
  <app-user [(showProfile)]="showProfile"></app-user>
  }

  <!-- Settings Modal -->
  @if (showSettings()) {
  <app-settings
    [(showSettings)]="showSettings"
    (salvoComSucesso)="this.addMessage('model', 'text', $event)"
  ></app-settings>
  }

  <input
    type="file"
    #importFileInput
    class="hidden"
    (change)="importData($event)"
    accept=".json"
  />
</div>
